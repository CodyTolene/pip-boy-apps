function drawTitleScreen(){C.clear(),C.setFontAlign(-1,-1),C.setFont('6x8',2),drawCentered('FLAPPY-ROACH',Math.floor(H*.25)),C.setFont('6x8',1),drawCentered('Knob1 or Radio PLAY',Math.floor(H*.52)),drawCentered('to START',Math.floor(H*.6)),drawCentered('Torch: pause menu',Math.floor(H*.78)),flushScreen()}function startRun(){exitingToApps=!1,inTitle=!1,gameOver=!1,paused=!1,bird.y=H/2,bird.vy=0,pipes=[],newPipe(),playSound(SND_START)}function playSound(a){try{Pip.audioStop(),Pip.audioStart(a)}catch(a){console.log('Audio error:',a)}}function playFlapSound(){let a=getTime()*1e3;if(a-lastFlapSoundT<120)return;lastFlapSoundT=a,playSound(SND_FLAP)}function drawSplat(b,c,e,f){let d=Math.max(2,e+Math.floor(f*6));C.fillRect(b-d,c-d,b+d,c+d);let a=d+2;C.fillRect(b-a,c-1,b-a+2,c+1),C.fillRect(b+a-2,c-1,b+a,c+1),C.fillRect(b-1,c-a,b+1,c-a+2),C.fillRect(b-1,c+a-2,b+1,c+a),C.fillRect(b-a,c-a,b-a+2,c-a+2),C.fillRect(b+a-2,c-a,b+a,c-a+2),C.fillRect(b-a,c+a-2,b-a+2,c+a),C.fillRect(b+a-2,c+a-2,b+a,c+a),impactFX&&impactFX.kind==='HIT'&&C.drawLine(b-d-2,c,b+d+2,c)}function flapAction(){if(getTime()<inputLockedUntil)return;if(showingScoreScreen){showingScoreScreen=!1,exitToApps();return}if(paused&&!gameOver){pauseSelect();return}if(inTitle){startRun();return}if(gameOver){resetGame(),startRun();return}bird.vy=FLAP,roachFlapT=6,roachTilt=-1,playFlapSound()}function saveHighScoreIfNeeded(a){a>highScore&&(highScore=a,Storage.writeJSON(HS_KEY,highScore))}function togglePause(){paused=!paused,paused&&(menuIndex=0,inputLockedUntil=getTime()+.15,knob1WasDown=(typeof KNOB1_BTN)[0]!='u'?KNOB1_BTN.read():!1,playWasDown=(typeof BTN_PLAY)[0]!='u'?BTN_PLAY.read():!1)}function pauseSelect(){let a=menuItems[menuIndex];if(a==='RESUME')paused=!1;else if(a==='RESTART')paused=!1,resetGame(),startRun&&startRun();else if(a.indexOf('QUIT')===0){try{saveHighScoreIfNeeded(score)}catch(a){}try{C.clear(),flushScreen()}catch(a){}E.reboot()}}function exitToApps(){if(exitingToApps)return;exitingToApps=!0,exitTO1&&(clearTimeout(exitTO1),exitTO1=null),exitTO2&&(clearTimeout(exitTO2),exitTO2=null),stopGame();try{global.Pip&&Pip.removeAllListeners()}catch(a){}try{C.clear(),flushScreen()}catch(a){}exitTO1=setTimeout(()=>{exitTO1=null;try{C.clear(),flushScreen()}catch(a){}exitTO2=setTimeout(()=>{exitTO2=null;try{if((typeof submenuApps)[0]=='f')submenuApps();else if((typeof showMainMenu)[0]=='f')showMainMenu();else{C.clear(),C.setFont('6x8',2),C.setFontAlign(-1,-1);let a='Exited';let b=Math.max(0,W-C.stringWidth(a)>>1);C.drawString(a,b,Math.floor(H*.45)),flushScreen()}}catch(a){}},120)},40)}function flushScreen(){return C&&C.flip?C.flip():C&&C.flush?C.flush():C&&C.update?C.update():global.LCD&&LCD.flip?LCD.flip():void 0}function newPipe(){let a=Math.min(PIPE_GAP,H-30);let b=10;let c=H-a-b*2;let d=b+Math.random()*(c>0?c:1);pipes.push({x:W,gapY:d,scored:!1,gap:a})}function resetGame(){W=C.getWidth(),H=C.getHeight(),paused=!1,gameOver=!1,showingScoreScreen=!1,bird={x:Math.floor(W*.25),y:H/2,vy:0,size:6},pipes=[],score=0,inTitle=!0}function update(){if(exitingToApps)return;if(pipes||(pipes=[]),(typeof BTN_PLAY)[0]!='u'){let a=BTN_PLAY.read();a&&!playWasDown&&flapAction(),playWasDown=a}if((typeof KNOB1_BTN)[0]!='u'){let a=KNOB1_BTN.read();a&&!knob1WasDown&&flapAction(),knob1WasDown=a}if(showingScoreScreen)return;if(inTitle)return;if(gameOver||paused)return;roachFlapT>0&&roachFlapT--;let a=0;bird&&isFinite(bird.vy)&&(a=bird.vy<0?-1:1),roachTilt+=(a-roachTilt)*.15,bird.vy+=GRAVITY,bird.y+=bird.vy,isFinite(bird.y)||(bird.y=H/2,bird.vy=0),(bird.y<0||bird.y+bird.size>H)&&endRun('FELL');for(let c=0;c<pipes.length;c++){let a=pipes[c];a.x-=PIPE_SPEED,bird.x+bird.size>a.x&&bird.x<a.x+PIPE_WIDTH&&(bird.y<a.gapY||bird.y+bird.size>a.gapY+a.gap)&&endRun('HIT'),!a.scored&&a.x+PIPE_WIDTH<bird.x&&(a.scored=!0,score++)}let b=pipes[pipes.length-1];b?b.x<=W-PIPE_SPACING&&newPipe():newPipe(),pipes.length&&pipes[0].x<-PIPE_WIDTH&&pipes.shift()}function drawCentered(a,d){if(exitingToApps)return;C.setFontAlign(-1,-1);let b=C.stringWidth(a);let c=Math.max(0,Math.floor((W-b)/2));C.drawString(a,c,d)}function draw(){if(exitingToApps)return;if(inTitle){drawTitleScreen();return}if(showingScoreScreen)return;pipes||(pipes=[]),C.clear();for(let a=0;a<pipes.length;a++){let b=pipes[a];C.fillRect(b.x,0,b.x+PIPE_WIDTH,b.gapY),C.fillRect(b.x,b.gapY+b.gap,b.x+PIPE_WIDTH,H)}if(drawRadroach(bird.x,bird.y,bird.size,frameCount,roachFlapT,roachTilt),C.setFont('6x8',2),C.setFontAlign(-1,-1),C.drawString(' Score: '+score,2,2),gameOver){if(!showGameOverUI&&impactFX){let a=Math.min(1,(getTime()-impactFX.t0)/.75);drawSplat(impactFX.x,impactFX.y,3,a),flushScreen();return}C.clear(),C.setFont('6x8',3),drawCentered('GAME OVER',Math.floor(H*.14)),C.setFont('6x8',2),drawCentered('Score: '+finalScore,Math.floor(H*.3)),drawCentered('Highest Score: '+highScore,Math.floor(H*.4)),drawCentered('Knob1/Radio: Play Again',Math.floor(H*.64)),drawCentered('Power: Exit to MAIN',Math.floor(H*.74))}else paused&&drawPauseMenu();flushScreen()}function drawRadroach(c,d,l,m,i,j){let a=Math.max(1,Math.floor(l/3));let g=Math.round(-j*2);let h=Math.round(j*2);C.fillRect(c+1*a+g,d+1*a,c+5*a+h,d+4*a),C.fillRect(c+2*a+g,d+0*a,c+4*a+g,d+1*a),C.fillRect(c+1*a+h,d+4*a,c+5*a+h,d+5*a);let k=frameCount>>3&1;let e=c+2*a+g;let f=c+4*a+g;let b=d+0*a;if(C.fillRect(e,b,e,b),C.fillRect(f,b,f,b),k&&(C.fillRect(e-1,b,e-1,b),C.fillRect(e+1,b,e+1,b),C.fillRect(e,b-1,e,b-1),C.fillRect(e,b+1,e,b+1),C.fillRect(f-1,b,f-1,b),C.fillRect(f+1,b,f+1,b),C.fillRect(f,b-1,f,b-1),C.fillRect(f,b+1,f,b+1)),i>0){let b=i&1?3:2;C.drawLine(c+1*a+g,d+2*a,c-b*a,d+1*a),C.drawLine(c+1*a+g,d+3*a,c-b*a,d+4*a),C.drawLine(c+5*a+h,d+2*a,c+(6+b)*a,d+1*a),C.drawLine(c+5*a+h,d+3*a,c+(6+b)*a,d+4*a)}C.fillRect(c+0*a+g,d+2*a,c+0*a+g,d+2*a),C.fillRect(c+6*a+h,d+2*a,c+6*a+h,d+2*a)}function bindGameControls(){Pip.removeAllListeners(),Pip.on('torch',()=>{!gameOver&&(typeof togglePause)[0]=='f'&&togglePause()}),Pip.on('knob1',a=>{if(paused&&!gameOver){a>0?menuIndex=(menuIndex+1)%menuItems.length:a<0&&(menuIndex=(menuIndex+menuItems.length-1)%menuItems.length);return}})}function drawPauseMenu(){C.clear(),C.setFontAlign(-1,-1),C.drawRect(10,20,W-10,H-20),C.setFont('6x8',3),drawCentered('PAUSED',28),C.setFont('6x8',2);for(let a=0;a<menuItems.length;a++){let b=56+a*16;let c=(a===menuIndex?'> ':'  ')+menuItems[a];drawCentered(c,b)}C.setFont('6x8',1.5),drawCentered('Torch: Pause/Resume',H-40),drawCentered('Knob1 Press: Select',H-30)}function stopGame(){loopId&&(clearInterval(loopId),loopId=null),powerWatchId&&(clearWatch(powerWatchId),powerWatchId=null),exitTO1&&(clearTimeout(exitTO1),exitTO1=null),exitTO2&&(clearTimeout(exitTO2),exitTO2=null),tOverSound&&(clearTimeout(tOverSound),tOverSound=null),tImpactClear&&(clearTimeout(tImpactClear),tImpactClear=null),global.Pip&&Pip.removeAllListeners()}function endRun(a){gameOver=!0,paused=!1,inputLockedUntil=getTime()+.75,finalScore=score,saveHighScoreIfNeeded(finalScore),lastRunReason=a||'',showGameOverUI=!1,impactFX={kind:a,x:Math.round(bird.x+bird.size/2),y:a==='FELL'?Math.min(H-6,Math.round(bird.y+bird.size/2)):Math.round(bird.y+bird.size/2),t0:getTime()},a==='HIT'&&playSound(SND_SPLAT),a==='FELL'&&playSound(SND_HIT),tOverSound&&(clearTimeout(tOverSound),tOverSound=null),tImpactClear&&(clearTimeout(tImpactClear),tImpactClear=null),tOverSound=setTimeout(()=>playSound(SND_OVER),500),tImpactClear=setTimeout(()=>{showGameOverUI=!0,impactFX=null,tImpactClear=null},750)}function startGame(){exitingToApps=!1,stopGame(),resetGame(),draw(),playSound(SND_START),bindGameControls(),powerWatchId=setWatch(()=>{E.reboot()},BTN_POWER,{debounce:50,edge:'rising',repeat:!0}),draw(),loopId=setInterval(()=>{update(),draw(),frameCount++},50)}Pip.removeSubmenu&&Pip.removeSubmenu(),delete Pip.removeSubmenu,Pip.remove&&Pip.remove(),delete Pip.remove;let C=(typeof bC)[0]!='u'?bC:g,Storage=require('Storage'),HS_KEY='flappy_hs',inTitle=!0,highScore=Storage.readJSON(HS_KEY,1)||0,paused=!1,menuItems=['RESUME','RESTART','QUIT (REBOOT)'],menuIndex=0,W=C.getWidth(),H=C.getHeight(),finalScore=0,lastRunReason='',bird,pipes=[],score=0,gameOver=!1,loopId=null,powerWatchId=null,showingScoreScreen=!1,playWasDown=!1,knob1WasDown=!1,frameCount=0,roachFlapT=0,roachTilt=0,tOverSound=null,tImpactClear=null,lastFlapSoundT=0,impactFX=null,showGameOverUI=!0,exitingToApps=!1,inputLockedUntil=0,GRAVITY=.4,FLAP=-5,PIPE_SPEED=2.5,PIPE_GAP=40,PIPE_WIDTH=15,PIPE_SPACING=180,SND_FLAP='/USER/FLAPPYROACH/BeetleFlying.wav',SND_HIT='/USER/FLAPPYROACH/HitGround.wav',SND_OVER='/USER/FLAPPYROACH/GameOver.wav',SND_SPLAT='/USER/FLAPPYROACH/SplatOnPipe.wav',SND_START='/USER/FLAPPYROACH/StartGame.wav',exitTO1=null,exitTO2=null;startGame()