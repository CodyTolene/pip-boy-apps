function CustomRadio(){function a2(){I&&clearInterval(I),I=null}function z(){g.setColor(a0).fillRect(m)}function aq(){x&&clearInterval(x),x=null,y=null,j&&(j=null,E.defrag())}function r(){if(aj===!1)return;g.setColor(a1),g.drawRect(b),g.drawRect(c),g.drawRect(m),g.drawRect(ak),g.drawRect(A),a5()}function ar(){const d=af.toUpperCase();const e='v'+ag;const a=5;const f=g.stringWidth(d);g.setColor(u).setFontAlign(-1,-1,0).setFontMonofonto16().drawString(d,c.x1,b.y1+8),g.setColor(K).setFontAlign(-1,-1,0).setFont('6x8').drawString(e,c.x1+f+a,b.y1+16),g.setColor(a1).drawLine(c.x1,c.y1-a,c.x2,c.y1-a)}function as(){a2(),I=setInterval(drawFooter,ao)}function a3(d){let b=d.name;let c=u;d.type==='ptl'&&(b='FILE PATH TOO LONG!',c=J);const a=b.replace(/\.wav$/i,'');const e=a.length>21?a.slice(0,18)+'...':a;g.setColor(c).setFontAlign(1,-1,0).setFont('6x8').drawString(e,m.x2,m.y1+20)}function v(){g.setColor(K).setFontAlign(1,1,0).setFont('6x8').drawString('Now Playing',m.x2,m.y1+15)}function a4(){const e=q*s;const f=d.slice(e,e+s);g.setColor(a0).fillRect(c),g.setFontMonofonto16().setFontAlign(-1,-1,0);const a=4;const b=4;const i=5;const j=20;f.forEach((e,m)=>{const f=c.y1+m*j+i;let l=av(e);let k=K;e.type==='ptl'?m===h?k=J:k=ap:m===h&&(k=u),g.setColor(k);let d=c.x1;e.type==='folder'?(g.drawImage(X,d,f+a),d+=X.width+b):e.type==='up'?(g.drawImage(Y,d,f+a),d+=Y.width+b):e.type==='file'?(g.drawImage(Z,d,f+a),d+=Z.width+b):e.type==='ptl'?(g.drawImage(_,d,f+a),d+=_.width+b):e.type==='random'&&(g.drawImage($,d,f+a),d+=$.width+b);const n=c.x2-2-d;l=au(l,n),g.drawString(l,d,f,!0)}),r()}function a5(){const d=5;const h=3;const e=A.x1-R;const c=A.y1;const b=A.x2;const i=A.y2;const a=i-1;const f=b;for(let j=0;j<40;j++){const k=j%d===0?u:K;const b=j%d===0?2:1;const i=e+j*h;const l=a-b;g.setColor(k),g.drawLine(i,l,i,a),g.drawLine(f-b,c+j*3,f,c+j*3)}g.setColor(u),g.drawLine(e,a,b,a),g.drawLine(b,a,b,c)}function at(){N=0,j=Graphics.createArrayBuffer(120,120,2,{msb:!0}),E.getAddressOf(j,0)===0&&(j=undefined,E.defrag(),j=Graphics.createArrayBuffer(120,120,2,{msb:!0})),y=new Uint16Array(60);for(let a=0;a<60;a+=2)y[a]=a*2;x&&clearInterval(x),x=setInterval(()=>{if(D)return;if(!j)return;if(j.clearRect(0,0,119,119),Pip.radioClipPlaying)Pip.getAudioWaveform(y,20,100);else{let a=N;for(let b=1;b<60;b+=2)y[b]=60+Math.sin(a)*45*Math.sin((a+=.6)*.13)}j.drawPolyAA(y),N+=.3,Pip.blitImage(j,285,75,{noScanEffect:!0})},an)}function au(a,f){if(g.stringWidth(a)<=f)return a;const d='...';const h=g.stringWidth(d);let b=0;let c=a.length;let e=0;while(b<=c){const d=b+c>>1;const i=a.slice(0,d);g.stringWidth(i)+h<=f?(e=d,b=d+1):c=d-1}return a.slice(0,e)+d}function av(b){let a=b.name;return b.type!=='folder'&&(a=a.replace(/\.wav$/i,'')),a}function aw(b){const a=b.lastIndexOf('/');return a<=0?G:b.slice(0,a)}function a6(){f=!0,B=!0,z(),v();const a='File play error';g.setColor(J).setFontAlign(1,-1,0).setFont('6x8').drawString(a,m.x2,m.y1+20,!0),r()}function w(){if(!f)return;f=!1,B=!1,z(),v(),r()}function ax(c){if(f&&w(),D||k)return;const b=Date.now();if(b-V<al)return;if(V=b,c!==0)return a9(c*-1);const e=q*s;const a=d[e+h];if(!a)return;if(a.type==='random'){l?(l=!1,F()):n!==null?(l=!0,i='RANDOM',F()):ae();return}if(a.type==='ptl'){l=!1,i=null,n=null,Pip.radioClipPlaying=!1,F(),z(),v(),a3(a),r();return}if(a.type==='up'){aa(aw(p));return}if(a.type==='folder'){aa(L(p,a.name));return}if(a.type==='file'){const b=ab(p,a.name);if(n===b){i=null,F();return}if(l=!1,n!==null){i=a,F();return}M(a);return}}function ay(){f&&w(),a2(),aq(),ad(),settings.idleTimeout=Q,E.reboot()}function az(a){if(f&&w(),D||k)return;a9(a)}function aA(){f&&w();const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aB(a){try{const b=fs.statSync('/'+a);return!!b&&!!b.dir}catch(a){return!1}}function a7(a,b){return('/'+L(a,b)).length>am}function a8(b){let a=b||p;D=!0;try{aF(),e&&(clearTimeout(e),e=null),k=!1,a===G&&E.defrag();let b=[];try{b=fs.readdir('/'+a).filter(a=>a!=='.'&&a!=='..').sort()}catch(c){print('Failed to read dir:',a,c);try{E.defrag(),b=fs.readdir('/'+a).filter(a=>a!=='.'&&a!=='..').sort()}catch(c){print('Retry failed to read dir:',a,c),b=[]}}const c=[];const f=[];for(let d=0;d<b.length;d++){const e=b[d];if(/\.wav$/i.test(e)){f.push(e);continue}const g=L(a,e);aB(g)&&c.push(e)}d.push({type:'random',name:'RANDOM'}),a!==G&&d.push({type:'up',name:'BACK'}),c.forEach(b=>{a7(a,b)?d.push({name:b,type:'ptl'}):d.push({name:b,type:'folder'})}),f.forEach(b=>{a7(a,b)?d.push({name:b,type:'ptl'}):d.push({type:'file',name:b})}),C=d.filter(a=>a.type==='file'),print('Loaded folder '+a+': '+f.length+' songs, '+c.length+' folders.'),q=0,h=0,a4()}finally{D=!1}}function a9(e){f&&w();const a=q*s;const b=d.slice(a,a+s);const c=Math.floor((d.length-1)/s);h+=e,h<0?q>0?(q--,h=s-1):h=0:h>=b.length&&(q<c?(q++,h=0):h=b.length-1),a4()}function aa(a){f&&w(),l=!1,i=null,p=a,a8(p)}function aC(){if(f||B){B=!1,n=null,Pip.radioClipPlaying=!1;return}if(n=null,Pip.radioClipPlaying=!1,l){ac();return}if(i==='RANDOM'){i=null,ae();return}if(i){const a=i;i=null,M(a);return}z(),v(),r()}function L(a,b){return a?b?a+'/'+b:a:b}function aD(b){let a=b?String(b):'';while(a.length&&a[0]==='/')a=a.slice(1);while(a.indexOf('//')!==-1)a=a.replace('//','/');return a}function ab(a,b){return aD(L(a,b))}function M(b){function j(a){try{const b=fs.statSync('/'+a);return!!b&&!b.dir}catch(a){return!1}}function d(a){try{return Pip.audioStart(a),!0}catch(b){let c='';try{c=b?String(b):'(empty error)'}catch(a){c='(stringify failed)'}return print('audioStart failed:',a,c),!1}}f&&w(),B=!1;const a=ab(p,b.name);H++;const g=H;e&&(clearTimeout(e),e=null),k=!0,Pip.radioClipPlaying=!1;try{Pip.audioStop()}catch(a){}const c=j(a);if(print('Play request:',a,'len='+a.length,'exists='+c),!c){print('ERROR: file missing according to fs.statSync ->',a),k=!1,a6();return}const h=a;const i='/'+a;e=setTimeout(()=>{if(e=null,g!==H){k=!1,Pip.radioClipPlaying=!1;return}const c=d(h)||d(i);if(!c){k=!1,Pip.radioClipPlaying=!1,a6();return}n=a,Pip.radioClipPlaying=!0,o=b.name,z(),v(),a3(b),r(),k=!1},150)}function ac(){const b=C;if(!b.length){l=!1;return}if(b.length===1){M(b[0]);return}if(!a||t>=a.length){if(a=b.slice(),O(a),o&&a.length>1&&a[0].name===o){const b=a[0];a[0]=a[1],a[1]=b}t=0}let c=a[t++];if(o&&c.name===o)if(t<a.length)c=a[t++];else{if(a=b.slice(),O(a),a.length>1&&a[0].name===o){const b=a[0];a[0]=a[1],a[1]=b}t=1,c=a[0]}M(c)}function ad(){Pip.removeAllListeners(S),Pip.removeAllListeners(T),Pip.removeAllListeners(U),Pip.removeAllListeners(W)}function aE(){Pip.on(S,ax),Pip.on(T,az),Pip.on(U,aA),Pip.on(W,aC),setWatch(()=>ay(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})}function O(a){for(let b=a.length-1;b>0;b--){const c=(E.hwRand()>>>0)%(b+1);const d=a[b];a[b]=a[c],a[c]=d}}function ae(){if(l=!0,a=C.slice(),O(a),o&&a.length>1&&a[0].name===o){const b=1;const c=a[0];a[0]=a[b],a[b]=c}t=0,ac()}function F(){e&&(clearTimeout(e),e=null),H++,k=!1,Pip.audioStop(),n=null,Pip.radioClipPlaying=!1,z(),v(),r()}function aF(){d=null,C=null,a=null,d=[],C=[],a=[]}const P={};const af='Custom Radio';const ag='3.3.3';const ah=g.getWidth();const ai=g.getHeight();const aj=!1;let Q=settings.idleTimeout;const R=40;const b={x1:60,y1:40,x2:ah-60,y2:ai-20};const c={x1:b.x1+10,y1:b.y1+30,x2:(b.x2+b.x1)/2+R,y2:b.y2-20};const ak={x1:c.x2,y1:b.y1+30,x2:b.x2-10,y2:b.y2-20};const m={x1:c.x2,y1:b.y2-100,x2:b.x2-10,y2:b.y2-60};const A={x1:c.x2+45,y1:b.y1+37,x2:b.x2-12,y2:b.y2-101};const S='knob1';const T='knob2';const U='torch';const al=10;let V=0;const W='audioStopped';const G='RADIO';let n=null;let i=null;let o=null;let k=!1;let e=null;let H=0;let f=!1;let B=!1;const X=Graphics.createImage(`
    .......XXXXX..
    XXXXXXX.....XX
    X............X
    X............X
    X............X
    X............X
    X............X
    X............X
    XXXXXXXXXXXXXX
  `);const Y=Graphics.createImage(`
    ........X.....
    .......XX.....
    ......XXX.....
    .....XXXX.....
    ....XXXXX.....
    .....XXXX.....
    ......XXX.....
    .......XX.....
    ........X.....
  `);const Z=Graphics.createImage(`
    ..............
    ....XXXXXXXX..
    ....XX....XX..
    ....XX....XX..
    ....XX....XX..
    ....XX....XX..
    ..XXXX..XXXX..
    ..XXXX..XXXX..
    ..............
  `);const _=Graphics.createImage(`
    ..............
    ..XX......XX..
    ...XX....XX...
    ....XX..XX....
    .....XXXX.....
    ....XX..XX....
    ...XX....XX...
    ..XX......XX..
    ..............
  `);const $=Graphics.createImage(`
    ..XX..........
    .XX...........
    XXXXXXXXXXXXX.
    .XX...........
    ..XX......XX..
    ...........XX.
    .XXXXXXXXXXXXX
    ...........XX.
    ..........XX..
  `);const am=56;let p=G;let C=[];const s=10;let q=0;let h=0;let d=null;let l=!1;let a=[];let t=0;const an=50;let N=0;let j=null;let x=null;let y=null;const ao=49.99923706054;let I=null;let D=!1;const a0='#000000';const J='#FF0000';const ap=g.blendColor('#000',J,.5);const u=g.theme.fg;const K=g.blendColor('#000',u,.5);const a1=g.blendColor('#000',u,.75);return P.run=function(){Q=settings.idleTimeout,settings.idleTimeout=0,Pip.mode=MODE.RADIO,drawHeader(Pip.mode),ad(),aE(),a8(p),at(),a5(),ar(),as(),v(),r()},P}CustomRadio().run()