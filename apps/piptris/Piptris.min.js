function Piptris(){function H(){g.setColor(i),g.fillRect(0,0,w,z)}function S(){let a=0;for(let b=r-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!j[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)x(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)j[d*c+b]=j[(d-1)*c+b];for(let b=0;b<c;b++)j[b]=0;a++,F++,b++}}switch(a){case 1:p+=100;break;case 2:p+=300;break;case 3:p+=500;break;case 4:p+=800;break}}function u(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=r||f>=0&&j[f*c+e])return!0}return!1}function T(c,e){g.setColor(d);const a=[k+c*b,l+e*b,k+(c+1)*b-1,l+(e+1)*b-1];v?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function s(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function m(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?x(a.x+d,a.y+c):T(a.x+d,a.y+c))}function I(){g.setColor(d);for(let a=0;a<r;a++)for(let b=0;b<c;b++)j[a*c+b]?T(b,a):x(b,a);a6(),a3(),a5()}function U(){H();const a=w/2;const b=z/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor(q),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),V(Q,a-45,b+1),g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+p,a,b+50),y=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(y),a0())},100)}function V(a,b,c){try{let f=fs.readFileSync(a);let e=JSON.parse(f);let h={bpp:e.bpp,buffer:atob(e.buffer),height:e.height,transparent:e.transparent,width:e.width};g.setColor(d),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function a3(){const a=e.x1-65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const f=F.toString();const h=g.stringWidth(f);const j=16;g.setColor(i),g.fillRect(a-h/2-2,b+c-6,a+h/2+2,b+c+j-4),g.setColor(q),g.drawString('LINES',a,b),g.setColor(d),g.drawString(f,a,b+c)}function a4(){const c=20;const a=e.x1-65;const b=e.y1+25;g.setColor(q),g.setFont('6x8',2),g.drawString(M,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+a1,a,b+c)}function a5(){if(!n)return;const c=e.x2+65;const a=e.y1+25;const h=40;const k=40;g.setColor(i),g.fillRect(c-h/2-2,a+15,c+h/2,a+15+k),g.setFont('6x8',2),g.setColor(q),g.drawString('NEXT',c,a),g.setColor(d);const f=n.shape;const l=f[0].length*b;const j=c-l/2-2;for(let d=0;d<f.length;d++)for(let e=0;e<f[d].length;e++)if(f[d][e]){const c=[j+e*b,a+20+d*b,j+(e+1)*b-1,a+20+(d+1)*b-1];v?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function W(){if(!a||o)return;if(m(!0),a.y++,u(a)&&(a.y--,m(!1),Z(a),S(),K(),u(a))){o=!0,clearInterval(h),setTimeout(U,50);return}m(!1),s(e);const c=BTN_PLAY.read();const b=c?100:N;h._interval!==b&&(clearInterval(h),h=setInterval(W,b))}function a6(){const a=e.x2+65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const f=p.toString();const h=g.stringWidth(f);const j=16;g.setColor(i),g.fillRect(a-h/2-2,b+c-6,a+h/2+2,b+c+j-4),g.setColor(q),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(f,a,b+c)}function a7(){H();const a=w/2;const b=z/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString(M,a+10,b-50),g.setColor(q),g.setFont('6x8',2),g.drawString('Press    to START',a+10,b-15),V(Q,a-24,b-29),X()}function X(){const e=w/2;const a=10;const h=f.y2-15;const j=t.length*a;const k=t[0].length*a;const b=h-j-10;const c=e-k/2;g.setFont('6x8',1),g.setColor(q),g.drawString('<- BLOCK TYPE ->',e,h),g.setColor(i),g.fillRect(c-2,b-2,c+k+2,b+j+2),g.setColor(d);for(let d=0;d<t.length;d++)for(let f=0;f<t[d].length;f++)if(t[d][f]){const e=c+f*a;const h=b+d*a;const i=e+a-1;const j=h+a-1;v?g.drawRect(e,h,i,j):g.fillRect(e,h,i,j)}}function a8(){if(!a||o)return;m(!0);while(!u(a))a.y++;a.y--,m(!1),Z(a),S(),I(),K(),m(!1)}function x(a,c){g.setColor(i),g.fillRect(k+a*b,l+c*b,k+(a+1)*b-1,l+(c+1)*b-1)}function J(){let b=Math.floor(Math.random()*R.length);let a=R[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function a9(){_()}function aa(b){let a=Date.now();if(a-O<a2)return;O=a,b===0?a8():af(b)}function ab(){$(),clearInterval(h),bC.clear(1).flip(),E.reboot()}function ac(a){ad(a>0?1:-1)}function Y(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function Z(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(j[(a.y+b)*c+a.x+d]=1)}function ad(c){if(o||!a)return;let b=a.x;if(a.x+=c,u(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&x(b+e,a.y+d);m(!1),D&&s(f),s(e)}function _(){if(!G.length)return;const a=G[Math.floor(Math.random()*G.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function ae(){j.fill(0),g.setColor(i),g.fillRect(k,l,k+c*b-1,l+r*b-1)}function af(g){if(o||!a)return;const b=a.shape;const d=g>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,u(a)){a.shape=c;return}for(let e=0;e<c.length;e++)for(let f=0;f<c[e].length;f++)c[e][f]&&x(a.x+f,a.y+e);m(!1),D&&s(f),s(e)}function $(){Pip.removeAllListeners(A),Pip.removeAllListeners(B),Pip.removeAllListeners(C),Pip.removeAllListeners(P)}function ag(){Pip.on(A,aa),Pip.on(B,ac),Pip.on(C,Y),Pip.on(P,a9)}function K(){n||(n=J()),a=n,n=J(),I(),u(a)&&(o=!0,clearInterval(h),setTimeout(()=>{U()},50))}function a0(){clearInterval(h),$(),_(),p=0,F=0,o=!1,a=null,n=J(),H(),ae(),s(e),D&&s(f),K(),I(),a4(),ag(),h=setInterval(W,N)}const L={};const M='Piptris';const a1='2.3.0';const D=!0;let a=null;let N=800;let n=null;let b=10;let y=null;let o=!1;let F=0;let h=null;let p=0;let v=!1;const w=g.getWidth();const z=g.getHeight();const f={x1:60,x2:w-60,y1:10,y2:z-10};const i='#000';const d=g.theme.fg;const q=g.blendColor(i,d,.75);const c=10;const r=20;const j=new Uint8Array(c*r);const k=(f.x1+f.x2)/2-b*c/2;const l=f.y1+(f.y2-f.y1)/2-b*r/2;const e={x1:k-1,y1:l-1,x2:k+c*b,y2:l+r*b};const A='knob1';const B='knob2';const C='torch';const a2=30;let O=0;const P='audioStopped';const G=['USER/piptris.wav'];const Q='USER/gear.json';const t=[[0,1,0],[1,1,1]];const R=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],t,[[1,1],[1,1]]];return L.run=function(){function a(){v=!v,X()}bC.clear(),a7(),Pip.on(A,a),Pip.on(B,a),Pip.on(C,Y),y=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(y),Pip.removeListener(A,a),Pip.removeListener(B,a),Pip.removeAllListeners(C),a0())},100),setWatch(()=>ab(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},L}Piptris().run()