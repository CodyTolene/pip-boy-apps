function Piptris(){function H(){g.setColor(h),g.fillRect(0,0,w,z)}function S(){let a=0;for(let b=p-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!i[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)x(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)i[d*c+b]=i[(d-1)*c+b];for(let b=0;b<c;b++)i[b]=0;a++,F++,b++}}switch(a){case 1:o+=100;break;case 2:o+=300;break;case 3:o+=500;break;case 4:o+=800;break}}function u(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=p||f>=0&&i[f*c+e])return!0}return!1}function T(c,e){g.setColor(d);const a=[j+c*b,k+e*b,j+(c+1)*b-1,k+(e+1)*b-1];v?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function q(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function l(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?x(a.x+d,a.y+c):T(a.x+d,a.y+c))}function I(){g.setColor(d);for(let a=0;a<p;a++)for(let b=0;b<c;b++)i[a*c+b]?T(b,a):x(b,a);a6(),a3(),a5()}function U(){H();const a=w/2;const b=z/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor(s),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),V(Q,a-45,b+1),g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+o,a,b+50),y=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(y),a0())},100)}function V(a,b,c){try{let f=fs.readFileSync(a);let e=JSON.parse(f);let h={bpp:e.bpp,buffer:atob(e.buffer),height:e.height,transparent:e.transparent,width:e.width};g.setColor(d),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function a3(){const a=e.x1-65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const i=F.toString();const p=g.stringWidth(i);const n=16;const j=80;const o=c+n+10;const k=a-j/2;const f=b+c-8;const l=a+j/2;const m=f+o;g.setColor(h),g.fillRect(k,f,l,m),D&&q({x1:k-1,y1:f-1,x2:l+1,y2:m+1}),g.setColor(s),g.drawString('LINES',a,b),g.setColor(d),g.drawString(i,a,b+c)}function a4(){const c=20;const a=e.x1-60;const b=e.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(M,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+a1,a,b+c)}function a5(){if(!m)return;const c=e.x2+65;const a=e.y1+25;const j=4*b;const f=6;const k=c-j/2-f;const l=a+15-f;const n=c+j/2+f;const o=a+15+j+f;g.setColor(h),g.fillRect(k,l,n,o),D&&q({x1:k-1,y1:l-1,x2:n+1,y2:o+1}),g.setFont('6x8',2),g.setColor(s),g.drawString('NEXT',c,a),g.setColor(d);const i=m.shape;const r=i[0].length*b;const p=c-r/2-2;for(let d=0;d<i.length;d++)for(let e=0;e<i[d].length;e++)if(i[d][e]){const c=[p+e*b,a+20+d*b,p+(e+1)*b-1,a+20+(d+1)*b-1];v?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function W(){if(!a||n)return;if(l(!0),a.y++,u(a)&&(a.y--,l(!1),Z(a),S(),K(),u(a))){n=!0,clearInterval(f),setTimeout(U,50);return}l(!1),q(e);const c=BTN_PLAY.read();const b=c?100:N;f._interval!==b&&(clearInterval(f),f=setInterval(W,b))}function a6(){const a=e.x2+65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const i=o.toString();const r=g.stringWidth(i);const n=16;const j=100;const p=c+n+10;const k=a-j/2;const f=b+c-8;const l=a+j/2;const m=f+p;g.setColor(h),g.fillRect(k,f,l,m),D&&q({x1:k-1,y1:f-1,x2:l+1,y2:m+1}),g.setColor(s),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(i,a,b+c)}function a7(){H();const a=w/2;const b=z/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(M,a+10,b-50),g.setColor(s),g.setFont('6x8',2),g.drawString('Press    to START',a+10,b-15),V(Q,a-24,b-29),X()}function X(){const e=w/2;const a=10;const f=r.y2-15;const i=t.length*a;const j=t[0].length*a;const b=f-i-10;const c=e-j/2;g.setFont('6x8',1),g.setColor(s),g.drawString('<- BLOCK TYPE ->',e,f),g.setColor(h),g.fillRect(c-2,b-2,c+j+2,b+i+2),g.setColor(d);for(let d=0;d<t.length;d++)for(let h=0;h<t[d].length;h++)if(t[d][h]){const e=c+h*a;const f=b+d*a;const i=e+a-1;const j=f+a-1;v?g.drawRect(e,f,i,j):g.fillRect(e,f,i,j)}}function a8(){if(!a||n)return;l(!0);while(!u(a))a.y++;a.y--,l(!1),Z(a),S(),I(),K(),l(!1)}function x(a,c){g.setColor(h),g.fillRect(j+a*b,k+c*b,j+(a+1)*b-1,k+(c+1)*b-1)}function J(){let b=Math.floor(Math.random()*R.length);let a=R[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function a9(){_()}function aa(b){let a=Date.now();if(a-O<a2)return;O=a,b===0?a8():af(b)}function ab(){$(),clearInterval(f),bC.clear(1).flip(),E.reboot()}function ac(a){ad(a>0?1:-1)}function Y(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function Z(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(i[(a.y+b)*c+a.x+d]=1)}function ad(c){if(n||!a)return;let b=a.x;if(a.x+=c,u(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&x(b+e,a.y+d);l(!1),q(e)}function _(){if(!G.length)return;const a=G[Math.floor(Math.random()*G.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function ae(){i.fill(0),g.setColor(h),g.fillRect(j,k,j+c*b-1,k+p*b-1)}function af(f){if(n||!a)return;const b=a.shape;const d=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,u(a)){a.shape=c;return}for(let e=0;e<c.length;e++)for(let g=0;g<c[e].length;g++)c[e][g]&&x(a.x+g,a.y+e);l(!1),q(e)}function $(){Pip.removeAllListeners(A),Pip.removeAllListeners(B),Pip.removeAllListeners(C),Pip.removeAllListeners(P)}function ag(){Pip.on(A,aa),Pip.on(B,ac),Pip.on(C,Y),Pip.on(P,a9)}function K(){m||(m=J()),a=m,m=J(),I(),u(a)&&(n=!0,clearInterval(f),setTimeout(()=>{U()},50))}function a0(){clearInterval(f),$(),_(),o=0,F=0,n=!1,a=null,m=J(),H(),ae(),q(e),K(),I(),a4(),ag(),f=setInterval(W,N)}const L={};const M='PIPTRIS';const a1='2.3.0';const D=!1;let a=null;let N=800;let m=null;let b=15;let y=null;let n=!1;let F=0;let f=null;let o=0;let v=!1;const w=g.getWidth();const z=g.getHeight();const r={x1:60,x2:w-60,y1:10,y2:z-10};const h='#000';const d=g.theme.fg;const s=g.blendColor(h,d,.5);const c=10;const p=20;const i=new Uint8Array(c*p);const j=(r.x1+r.x2)/2-b*c/2;const k=r.y1+(r.y2-r.y1)/2-b*p/2;const e={x1:j-1,y1:k-1,x2:j+c*b,y2:k+p*b};const A='knob1';const B='knob2';const C='torch';const a2=30;let O=0;const P='audioStopped';const G=['USER/piptris.wav'];const Q='USER/gear.json';const t=[[0,1,0],[1,1,1]];const R=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],t,[[1,1],[1,1]]];return L.run=function(){function a(){v=!v,X()}bC.clear(),a7(),Pip.on(A,a),Pip.on(B,a),Pip.on(C,Y),y=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(y),Pip.removeListener(A,a),Pip.removeListener(B,a),Pip.removeAllListeners(C),a0())},100),setWatch(()=>ab(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},L}Piptris().run()