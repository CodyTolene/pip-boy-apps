function Piptris(){function L(){g.setColor(h),g.fillRect(0,0,A,D)}function Y(){let a=0;for(let b=t-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!j[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)B(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)j[d*c+b]=j[(d-1)*c+b];for(let b=0;b<c;b++)j[b]=0;a++,y++,b++,ao()}}switch(a){case 1:i+=100;break;case 2:i+=300;break;case 3:i+=500;break;case 4:i+=800;break}}function w(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=t||f>=0&&j[f*c+e])return!0}return!1}function Z(c,e){g.setColor(d);const a=[k+c*b,l+e*b,k+(c+1)*b-1,l+(e+1)*b-1];z?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function m(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function n(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?B(a.x+d,a.y+c):Z(a.x+d,a.y+c))}function M(){g.setColor(d);for(let a=0;a<t;a++)for(let b=0;b<c;b++)j[a*c+b]?Z(b,a):B(b,a);a2(),a0(),ab(),ad()}function _(){L();const a=A/2;const b=D/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor(s),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),$(W,a-45,b+1);const c=b+80;const e=18;g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+i,a,c),g.drawString('Level: '+f,a,c+e),g.drawString('Lines: '+y,a,c+e*2),C=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(C),a8())},100)}function $(a,b,c){try{let f=fs.readFileSync(a);let e=JSON.parse(f);let h={bpp:e.bpp,buffer:atob(e.buffer),height:e.height,transparent:e.transparent,width:e.width};g.setColor(d),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function ab(){const a=e.x1-65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const n=y.toString();const o=16;const i=80;const p=c+o+10;const j=a-i/2;const f=b+c-8;const k=a+i/2;const l=f+p;g.setColor(h),g.fillRect(j,f,k,l),x&&m({x1:j-1,y1:f-1,x2:k+1,y2:l+1}),g.setColor(s),g.drawString('LINES',a,b),g.setColor(d),g.drawString(n,a,b+c)}function ac(){const c=20;const a=e.x1-60;const b=e.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(Q,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+a9,a,b+c)}function a0(){const a=e.x1-65;const b=e.y2-120;const j=20;g.setFont('6x8',2);const k=f.toString();const l=g.stringWidth(k);const q=16;const c=4;const n=a-l/2-c;const i=b+j-4;const o=a+l/2+c;const p=i+q+c;g.setColor(h),g.fillRect(n,i,o,p),x&&m({x1:n-1,y1:i-1,x2:o+1,y2:p+1}),g.setColor(s),g.drawString('LEVEL',a,b),g.setColor(d),g.drawString(k,a,b+j)}function ad(){if(!p)return;const c=e.x2+65;const a=e.y1+25;const j=4*b;const f=6;const k=c-j/2-f;const l=a+15-f;const n=c+j/2+f;const o=a+15+j+f;g.setColor(h),g.fillRect(k,l,n,o),x&&m({x1:k-1,y1:l-1,x2:n+1,y2:o+1}),g.setFont('6x8',2),g.setColor(s),g.drawString('NEXT',c,a),g.setColor(d);const i=p.shape;const r=i[0].length*b;const q=c-r/2-2;for(let d=0;d<i.length;d++)for(let e=0;e<i[d].length;e++)if(i[d][e]){const c=[q+e*b,a+20+d*b,q+(e+1)*b-1,a+20+(d+1)*b-1];z?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function a1(){if(!a||q)return;if(n(!0),a.y++,w(a)&&(a.y--,n(!1),a5(a),Y(),O(),w(a))){q=!0,clearInterval(r),setTimeout(_,50);return}n(!1),m(e);const c=BTN_PLAY.read();const b=c?100:o;J!==b&&(clearInterval(r),r=setInterval(a1,b),J=b)}function a2(){const a=e.x2+65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const j=i.toString();const r=g.stringWidth(j);const p=16;const k=100;const q=c+p+10;const l=a-k/2;const f=b+c-8;const n=a+k/2;const o=f+q;g.setColor(h),g.fillRect(l,f,n,o),x&&m({x1:l-1,y1:f-1,x2:n+1,y2:o+1}),g.setColor(s),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(j,a,b+c)}function ae(){L();const a=A/2;const b=D/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(Q,a+10,b-50),g.setColor(s),g.setFont('6x8',2),g.drawString('Press    to START',a+10,b-15),$(W,a-24,b-29),a3()}function a3(){const e=A/2;const a=10;const f=u.y2-15;const i=v.length*a;const j=v[0].length*a;const b=f-i-10;const c=e-j/2;g.setFont('6x8',1),g.setColor(s),g.drawString('<- BLOCK TYPE ->',e,f),g.setColor(h),g.fillRect(c-2,b-2,c+j+2,b+i+2),g.setColor(d);for(let d=0;d<v.length;d++)for(let h=0;h<v[d].length;h++)if(v[d][h]){const e=c+h*a;const f=b+d*a;const i=e+a-1;const j=f+a-1;z?g.drawRect(e,f,i,j):g.fillRect(e,f,i,j)}}function af(){if(!a||q)return;n(!0);while(!w(a))a.y++;a.y--,n(!1),a5(a),Y(),M(),O(),n(!1)}function B(a,c){g.setColor(h),g.fillRect(k+a*b,l+c*b,k+(a+1)*b-1,l+(c+1)*b-1)}function N(){let b=Math.floor(Math.random()*X.length);let a=X[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function ag(){a6()}function ah(b){let a=Date.now();if(a-U<aa)return;U=a,b===0?af():am(b)}function ai(){a7(),clearInterval(r),bC.clear(1).flip(),E.reboot()}function aj(a){ak(a>0?1:-1)}function a4(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function a5(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(j[(a.y+b)*c+a.x+d]=1)}function ak(c){if(q||!a)return;let b=a.x;if(a.x+=c,w(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&B(b+e,a.y+d);n(!1),m(e)}function a6(){if(!K.length)return;const a=K[Math.floor(Math.random()*K.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function al(){j.fill(0),g.setColor(h),g.fillRect(k,l,k+c*b-1,l+t*b-1)}function am(f){if(q||!a)return;const b=a.shape;const d=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,w(a)){a.shape=c;return}for(let e=0;e<c.length;e++)for(let g=0;g<c[e].length;g++)c[e][g]&&B(a.x+g,a.y+e);n(!1),m(e)}function a7(){Pip.removeAllListeners(F),Pip.removeAllListeners(G),Pip.removeAllListeners(H),Pip.removeAllListeners(V)}function an(){Pip.on(F,ah),Pip.on(G,aj),Pip.on(H,a4),Pip.on(V,ag)}function O(){p||(p=N()),a=p,p=N(),M(),w(a)&&(q=!0,clearInterval(r),setTimeout(()=>{_()},50))}function a8(){clearInterval(r),a7(),a6(),q=!1,a=null,x?(f=10,i=1e4):(f=0,i=0),y=f*T,o=Math.max(I-f*S,R),J=o,p=N(),L(),al(),a0(),a2(),m(e),O(),M(),ac(),an(),r=setInterval(a1,o)}function ao(){let a=Math.floor(y/T);a>f&&(f=a,o=Math.max(I-f*S,R),console.log('Level up! New speed:',o,'ms'))}const P={};const Q='PIPTRIS';const a9='2.3.0';const x=!1;const I=800;let a=null;let o=I;let p=null;let b=15;let J=o;let C=null;let q=!1;let y=0;let r=null;let i=0;let z=!1;let f=0;const R=100;const S=50;const T=10;const A=g.getWidth();const D=g.getHeight();const u={x1:60,x2:A-60,y1:10,y2:D-10};const h='#000';const d=g.theme.fg;const s=g.blendColor(h,d,.5);const c=10;const t=20;const j=new Uint8Array(c*t);const k=(u.x1+u.x2)/2-b*c/2;const l=u.y1+(u.y2-u.y1)/2-b*t/2;const e={x1:k-1,y1:l-1,x2:k+c*b,y2:l+t*b};const F='knob1';const G='knob2';const H='torch';const aa=30;let U=0;const V='audioStopped';const K=['USER/piptris.wav'];const W='USER/gear.json';const v=[[0,1,0],[1,1,1]];const X=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],v,[[1,1],[1,1]]];return P.run=function(){function a(){z=!z,a3()}bC.clear(),ae(),Pip.on(F,a),Pip.on(G,a),Pip.on(H,a4),C=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(C),Pip.removeListener(F,a),Pip.removeListener(G,a),Pip.removeAllListeners(H),a8())},100),setWatch(()=>ai(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},P}Piptris().run()