function Piptris(){function G(){g.setColor(o),g.fillRect(0,0,v,y)}function R(){let a=0;for(let b=q-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!h[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)w(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)h[d*c+b]=h[(d-1)*c+b];for(let b=0;b<c;b++)h[b]=0;a++,D++,b++}}switch(a){case 1:n+=100;break;case 2:n+=300;break;case 3:n+=500;break;case 4:n+=800;break}}function t(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=q||f>=0&&h[f*c+e])return!0}return!1}function S(c,e){g.setColor(d);const a=[i+c*b,j+e*b,i+(c+1)*b-1,j+(e+1)*b-1];u?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function C(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function k(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?w(a.x+d,a.y+c):S(a.x+d,a.y+c))}function H(){g.setColor(d);for(let a=0;a<q;a++)for(let b=0;b<c;b++)h[a*c+b]?S(b,a):w(b,a);a5(),a2(),a4()}function T(){G();const a=v/2;const b=y/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor(p),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),U(P,a-45,b+1),g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+n,a,b+50),x=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(x),$())},100)}function U(a,b,c){try{let f=fs.readFileSync(a);let e=JSON.parse(f);let h={bpp:e.bpp,buffer:atob(e.buffer),height:e.height,transparent:e.transparent,width:e.width};g.setColor(d),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function a2(){const a=e.x1-65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const f=D.toString();const h=g.stringWidth(f);const i=16;g.setColor(o),g.fillRect(a-h/2-2,b+c-6,a+h/2+2,b+c+i-4),g.setColor(p),g.drawString('LINES',a,b),g.setColor(d),g.drawString(f,a,b+c)}function a3(){const c=20;const a=e.x1-65;const b=e.y1+25;g.setColor(p),g.setFont('6x8',2),g.drawString(L,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+a0,a,b+c)}function a4(){if(!l)return;const c=e.x2+65;const a=e.y2-60;const h=40;const j=40;g.setColor(o),g.fillRect(c-h/2-2,a+15,c+h/2,a+15+j),g.setFont('6x8',2),g.setColor(p),g.drawString('NEXT',c,a),g.setColor(d);const f=l.shape;const k=f[0].length*b;const i=c-k/2-2;for(let d=0;d<f.length;d++)for(let e=0;e<f[d].length;e++)if(f[d][e]){const c=[i+e*b,a+20+d*b,i+(e+1)*b-1,a+20+(d+1)*b-1];u?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function V(){if(!a||m)return;if(k(!0),a.y++,t(a)&&(a.y--,k(!1),Y(a),R(),J(),t(a))){m=!0,clearInterval(f),setTimeout(T,50);return}k(!1),C(e);const c=BTN_PLAY.read();const b=c?100:M;f._interval!==b&&(clearInterval(f),f=setInterval(V,b))}function a5(){const a=e.x2+65;const b=e.y1+25;const c=20;g.setFont('6x8',2);const f=n.toString();const h=g.stringWidth(f);const i=16;g.setColor(o),g.fillRect(a-h/2-2,b+c-6,a+h/2+2,b+c+i-4),g.setColor(p),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(f,a,b+c)}function a6(){G();const a=v/2;const b=y/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString(L,a+10,b-50),g.setColor(p),g.setFont('6x8',2),g.drawString('Press    to START',a+10,b-15),U(P,a-24,b-29),W()}function W(){const e=v/2;const a=10;const f=r.y2-15;const h=s.length*a;const i=s[0].length*a;const b=f-h-10;const c=e-i/2;g.setFont('6x8',1),g.setColor(p),g.drawString('<- BLOCK TYPE ->',e,f),g.setColor(o),g.fillRect(c-2,b-2,c+i+2,b+h+2),g.setColor(d);for(let d=0;d<s.length;d++)for(let j=0;j<s[d].length;j++)if(s[d][j]){const e=c+j*a;const f=b+d*a;const h=e+a-1;const i=f+a-1;u?g.drawRect(e,f,h,i):g.fillRect(e,f,h,i)}}function a7(){if(!a||m)return;k(!0);while(!t(a))a.y++;a.y--,k(!1),Y(a),R(),H(),J(),k(!1)}function w(a,c){g.setColor(o),g.fillRect(i+a*b,j+c*b,i+(a+1)*b-1,j+(c+1)*b-1)}function I(){let b=Math.floor(Math.random()*Q.length);let a=Q[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function a8(){Z()}function a9(b){let a=Date.now();if(a-N<a1)return;N=a,b===0?a7():ae(b)}function aa(){_(),clearInterval(f),bC.clear(1).flip(),E.reboot()}function ab(a){ac(a>0?1:-1)}function X(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function Y(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(h[(a.y+b)*c+a.x+d]=1)}function ac(c){if(m||!a)return;let b=a.x;if(a.x+=c,t(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&w(b+e,a.y+d);k(!1),C(e)}function Z(){if(!F.length)return;const a=F[Math.floor(Math.random()*F.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function ad(){h.fill(0),g.setColor(o),g.fillRect(i,j,i+c*b-1,j+q*b-1)}function ae(f){if(m||!a)return;const b=a.shape;const d=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,t(a)){a.shape=c;return}for(let e=0;e<c.length;e++)for(let g=0;g<c[e].length;g++)c[e][g]&&w(a.x+g,a.y+e);k(!1),C(e)}function _(){Pip.removeAllListeners(z),Pip.removeAllListeners(A),Pip.removeAllListeners(B),Pip.removeAllListeners(O)}function af(){Pip.on(z,a9),Pip.on(A,ab),Pip.on(B,X),Pip.on(O,a8)}function J(){l||(l=I()),a=l,l=I(),H(),t(a)&&(m=!0,clearInterval(f),setTimeout(()=>{T()},50))}function $(){clearInterval(f),_(),Z(),n=0,D=0,m=!1,a=null,l=I(),G(),ad(),C(e),J(),H(),a3(),af(),f=setInterval(V,M)}const K={};const L='Piptris';const a0='2.3.0';const ag=!1;let a=null;let M=800;let l=null;let b=10;let x=null;let m=!1;let D=0;let f=null;let n=0;let u=!1;const v=g.getWidth();const y=g.getHeight();const r={x1:60,x2:v-60,y1:10,y2:y-10};const d=g.theme.fg;const o='#000';const p='#FFF';const c=10;const q=20;const h=new Uint8Array(c*q);const i=(r.x1+r.x2)/2-b*c/2;const j=r.y1+(r.y2-r.y1)/2-b*q/2;const e={x1:i-1,y1:j-1,x2:i+c*b,y2:j+q*b};const z='knob1';const A='knob2';const B='torch';const a1=30;let N=0;const O='audioStopped';const F=['USER/piptris.wav'];const P='USER/gear.json';const s=[[0,1,0],[1,1,1]];const Q=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],s,[[1,1],[1,1]]];return K.run=function(){function a(){u=!u,W()}bC.clear(),a6(),Pip.on(z,a),Pip.on(A,a),Pip.on(B,X),x=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(x),Pip.removeListener(z,a),Pip.removeListener(A,a),Pip.removeAllListeners(B),$())},100),setWatch(()=>aa(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},K}Piptris().run()