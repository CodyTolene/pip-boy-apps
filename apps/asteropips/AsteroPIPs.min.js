function newAst(b,c){var a={x:b,y:c,vx:Math.random()-.5,vy:Math.random()-.5,rad:5+Math.random()*20};return a}function initGame(){clearInterval(),gameStart(),setInterval(onFrame,30)}function gameStop(){console.log('Game over'),running=!1,g.clear(),Pip.typeText('Game Over!\n\nLeft PUSH = Start\nTop Torch = Exit')}function endGame(){console.log('Game stopping'),running=!1,g.clear(),E.reboot()}function addAsteroids(){for(var a=0;a<level;a++){do var b=Math.random()*W,c=Math.random()*H,d=b-ship.x,e=c-ship.y,f=Math.sqrt(d*d+e*e);while(f<10);ast.push(newAst(b,c))}}function gameStart(){ammo=[],ast=[],score=0,level=4,ship={x:W/2,y:H/2,r:0,v:0},framesSinceFired=0,addAsteroids(),running=!0}function onFrame(){if(!running){BTNA.read()&&gameStart(),BTNE.read()&&endGame();return}BTNL.read()&&(ship.r-=.1),BTNR.read()&&(ship.r+=.1),ship.v*=.9,BTNU.read()&&(ship.v+=.2),ship.x+=Math.cos(ship.r)*ship.v,ship.y+=Math.sin(ship.r)*ship.v,ship.x<0&&(ship.x+=W),ship.y<0&&(ship.y+=H),ship.x>=W&&(ship.x-=W),ship.y>=H&&(ship.y-=H),framesSinceFired++,BTNA.read()&&framesSinceFired>5&&(framesSinceFired=0,ammo.push({x:ship.x+Math.cos(ship.r)*4,y:ship.y+Math.sin(ship.r)*4,vx:Math.cos(ship.r)*3,vy:Math.sin(ship.r)*3})),BTNE.read()&&endGame(),g.clear(),g.drawString(score,80,30);var b=Math.PI*.8;g.drawPoly([ship.x+Math.cos(ship.r)*8,ship.y+Math.sin(ship.r)*8,ship.x+Math.cos(ship.r+b)*6,ship.y+Math.sin(ship.r+b)*6,ship.x+Math.cos(ship.r-b)*6,ship.y+Math.sin(ship.r-b)*6],!0);var a=[];ammo.forEach(function(b){b.x+=b.vx,b.y+=b.vy,g.fillRect(b.x-1,b.y,b.x+1,b.y),g.fillRect(b.x,b.y-1,b.x,b.y+1);var c=!1;ast.forEach(function(a){var d=b.x-a.x,e=b.y-a.y,f=Math.sqrt(d*d+e*e);f<a.rad&&(c=!0,a.hit=!0,score++)}),!c&&b.x>=0&&b.y>=0&&b.x<W&&b.y<H&&a.push(b)}),ammo=a,a=[];var c=!1;ast.forEach(function(b){if(b.x+=b.vx,b.y+=b.vy,g.drawCircle(b.x,b.y,b.rad),b.x<0&&(b.x+=W),b.y<0&&(b.y+=H),b.x>=W&&(b.x-=W),b.y>=H&&(b.y-=H),!b.hit)a.push(b);else if(b.rad>5){b.hit=!1;var d=1*(Math.random()-.5),e=1*(Math.random()-.5);b.rad/=2,a.push({x:b.x,y:b.y,vx:b.vx-d,vy:b.vy-e,rad:b.rad}),b.vx+=d,b.vy+=e,a.push(b)}var f=b.x-ship.x,h=b.y-ship.y,i=Math.sqrt(f*f+h*h);i<b.rad+4&&(c=!0)}),ast=a,ast.length||(level++,addAsteroids()),c&&gameStop()}function initStart(){g.clear(),Pip.typeText('Welcome to AsteroPIPs!').then(()=>setTimeout(()=>{Pip.typeText('Right Tune UP/DOWN = Rotate\nRight Tune PUSH = Forward\nLeft PUSH = Start / Fire!\nTop Torch = Exit').then(()=>{const a=setInterval(()=>{BTNA.read()&&(clearInterval(a),initGame()),BTNE.read()&&(clearInterval(a),endGame())},100)})},3e3))}var W=g.getWidth(),H=g.getHeight(),BTNL=BTN_TUNEDOWN,BTNR=BTN_TUNEUP,BTNU=BTN_PLAY,BTNA=KNOB1_BTN,BTNE=BTN_TORCH;g.drawPoly||(g.drawPoly=function(a){g.moveTo(a[a.length-2],a[a.length-1]);for(var b=0;b<a.length;b+=2)g.lineTo(a[b],a[b+1])});var running=!0,ship={},ammo=[],ast=[],score=0,level=4,framesSinceFired=0;initStart()