function drawBoard(){bC.clear(),bC.setFont('6x8',2.5),bC.setColor(10);const a=3;for(let f=1;f<3;f++){let b=offsetX+f*(cellWidth+spacing)-spacing/2;let c=offsetY+f*(cellHeight+spacing)-spacing/2;for(let f=-Math.floor(a/2);f<=Math.floor(a/2);f++)bC.drawLine(b+f,offsetY,b+f,offsetY+boardHeight);for(let f=-Math.floor(a/2);f<=Math.floor(a/2);f++)bC.drawLine(offsetX,c+f,offsetX+boardWidth,c+f)}for(let f=0;f<3;f++)for(let g=0;g<3;g++){let a=board[f][g]||' ';let b=offsetX+g*(cellWidth+spacing)+cellWidth/2-8;let c=offsetY+f*(cellHeight+spacing)+cellHeight/2-8;bC.drawString(a,b,c)}let b=offsetX+cursorX*(cellWidth+spacing)-2;let c=offsetY+cursorY*(cellHeight+spacing)-2;let d=b+cellWidth+4;let e=c+cellHeight+4;if(bC.drawRect(b,c,d,e),!gameOver){let a=`Player ${currentPlayer}'s turn.`;let b=screenHeight-16;bC.drawString(a,(screenWidth-bC.stringWidth(a))/2,b)}bC.flip()}function checkWin(){const a=[board[0],board[1],board[2],[board[0][0],board[1][0],board[2][0]],[board[0][1],board[1][1],board[2][1]],[board[0][2],board[1][2],board[2][2]],[board[0][0],board[1][1],board[2][2]],[board[0][2],board[1][1],board[2][0]]];for(let b of a){if(b.every(a=>a==='X'))return'X';if(b.every(a=>a==='O'))return'O'}for(let b of board)if(b.includes(''))return null;return'Draw'}function checkWinner(a){const b=[a[0],a[1],a[2],[a[0][0],a[1][0],a[2][0]],[a[0][1],a[1][1],a[2][1]],[a[0][2],a[1][2],a[2][2]],[a[0][0],a[1][1],a[2][2]],[a[0][2],a[1][1],a[2][0]]];for(let c of b){if(c.every(a=>a==='X'))return'X';if(c.every(a=>a==='O'))return'O'}for(let c of a)if(c.includes(''))return null;return'Draw'}function minimax(a,c,d){let e=checkWinner(a);if(e!==null)return e==='O'?10-c:e==='X'?c-10:0;if(c>=2)return 0;let b=d?-Infinity:Infinity;for(let f=0;f<3;f++)for(let g=0;g<3;g++)if(a[f][g]===''){a[f][g]=d?'O':'X';let e=minimax(a,c+1,!d);a[f][g]='',b=d?Math.max(e,b):Math.min(e,b)}return b}function getBestMove(){let b=-Infinity;let c=null;let a=[];for(let d=0;d<3;d++)for(let e=0;e<3;e++)board[d][e]===''&&a.push({x,y});if(a.length===0)return null;for(let d of a){board[d.y][d.x]='O';let a=minimax(board,0,!1);board[d.y][d.x]='',a>b&&(b=a,c=d)}return c}function showGameOverMessage(b){let a=b==='Draw'?"It's a draw!":`Player ${b} wins!`;bC.clear(),bC.setFont('6x8',2.5),bC.setColor(10),bC.drawString(a,(screenWidth-bC.stringWidth(a))/2,screenHeight/2),bC.flip(),setTimeout(()=>{showMainMenu()},2e3)}function placeMark(){if(gameOver||board[cursorY][cursorX]!=='')return;board[cursorY][cursorX]=currentPlayer,drawBoard();let a=checkWin();if(a){gameOver=!0,showGameOverMessage(a);return}currentPlayer=currentPlayer==='X'?'O':'X',!gameOver&&vsCPU&&currentPlayer==='O'&&cpuMove()}function cpuMove(){if(gameOver||!vsCPU)return;let a;if(board[1][1]===''?a={x:1,y:1}:a=getBestMove(),!a)return;setTimeout(()=>{board[a.y][a.x]='O',drawBoard();let b=checkWin();if(b){gameOver=!0,showGameOverMessage(b);return}currentPlayer='X',drawBoard()},30)}function resetGame(){currentPlayer='X',board=[['','',''],['','',''],['','','']],cursorX=0,cursorY=0,gameOver=!1,bindGameControls(),drawBoard()}function bindGameControls(){Pip.removeAllListeners('knob1'),Pip.on('knob1',a=>{a===0?placeMark():(cursorY=a>0?(cursorY+2)%3:(cursorY+1)%3,drawBoard())}),Pip.removeAllListeners('knob2'),Pip.on('knob2',a=>{cursorX=a>0?(cursorX+1)%3:(cursorX+2)%3,drawBoard()}),Pip.removeAllListeners('torch'),Pip.on('torch',exitGame)}function exitGame(){gameOver=!0,inMenu=!0,Pip.removeAllListeners(),showMainMenu()}function showMainMenu(){function a(){bC.clear(),bC.setFont('6x8',2.5),bC.setColor(10);let a='PIP-TAC-TOE';bC.drawString(a,(screenWidth-bC.stringWidth(a))/2,20);for(let b=0;b<menuOptions.length;b++){let a=60+b*30;let c=menuOptions[b];b===menuSelection&&bC.drawRect(50,a-4,50+bC.stringWidth(c)+8,a+20),bC.drawString(c,54,a)}bC.flip()}inMenu=!0,a(),Pip.removeAllListeners(),Pip.on('knob1',b=>{b===0?(inMenu=!1,vsCPU=menuSelection===1,resetGame()):b>0?(menuSelection=(menuSelection+1)%menuOptions.length,a()):b<0&&(menuSelection=(menuSelection+menuOptions.length-1)%menuOptions.length,a())}),Pip.on('torch',()=>{bC.clear(),E.reboot()})}let currentPlayer='X';let board=[['','',''],['','',''],['','','']];let cursorX=0,cursorY=0;let gameOver=!1;let inMenu=!0;let menuOptions=['2 PLAYER','VS CPU'];let menuSelection=0;let vsCPU=!1;const screenWidth=bC.getWidth();const screenHeight=bC.getHeight();const spacing=10,cellWidth=50,cellHeight=50;const boardWidth=3*cellWidth+2*spacing;const boardHeight=3*cellHeight+2*spacing;const offsetX=(screenWidth-boardWidth)/2+10;const offsetY=(screenHeight-boardHeight)/2-16;setWatch(E.reboot,BTN_POWER,{debounce:50,edge:'rising',repeat:!0}),setTimeout(showMainMenu,100)