function Piptris(){function C(){g.setColor('#000'),g.fillRect(0,0,u,x)}function P(){let a=0;for(let b=o-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!h[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)v(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)h[d*c+b]=h[(d-1)*c+b];for(let b=0;b<c;b++)h[b]=0;a++,B++,b++}}switch(a){case 1:n+=100;break;case 2:n+=300;break;case 3:n+=500;break;case 4:n+=800;break}}function r(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=o||f>=0&&h[f*c+e])return!0}return!1}function Q(c,d){e.apply();const a=[i+c*b,j+d*b,i+(c+1)*b-1,j+(d+1)*b-1];t?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function A(a){e.set(0,1,0).apply(),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function k(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?v(a.x+d,a.y+c):Q(a.x+d,a.y+c))}function D(){e.apply();for(let a=0;a<o;a++)for(let b=0;b<c;b++)h[a*c+b]?Q(b,a):v(b,a);a2(),$(),a1()}function R(){C();const a=u/2;const b=x/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),S('USER/Piptris/gear.json',a-45,b+1),g.setColor('#0F0'),g.setFont('6x8',2),g.drawString('Score: '+n,a,b+50),w=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(w),Y())},100)}function S(a,b,c){try{let f=fs.readFileSync(a);let d=JSON.parse(f);let h={bpp:d.bpp,buffer:atob(d.buffer),height:d.height,transparent:d.transparent,width:d.width};e.apply(),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function $(){const a=d.x1-65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const f=B.toString();const h=g.stringWidth(f);const i=16;g.setColor('#000'),g.fillRect(a-h/2-2,b+c-6,a+h/2+2,b+c+i-4),g.setColor('#FFF'),g.drawString('LINES',a,b),e.apply(),g.drawString(f,a,b+c)}function a0(){const c=20;const a=d.x1-65;const b=d.y1+25;g.setColor('#FFF'),g.setFont('6x8',2),g.drawString(I,a,b),e.apply(),g.setFont('6x8',1),g.drawString('v'+Z,a,b+c)}function a1(){if(!l)return;const c=d.x2+65;const a=d.y2-60;const h=40;const j=40;g.setColor('#000'),g.fillRect(c-h/2-2,a+15,c+h/2,a+15+j),g.setFont('6x8',2),g.setColor('#FFF'),g.drawString('NEXT',c,a),e.apply();const f=l.shape;const k=f[0].length*b;const i=c-k/2-2;for(let d=0;d<f.length;d++)for(let e=0;e<f[d].length;e++)if(f[d][e]){const c=[i+e*b,a+20+d*b,i+(e+1)*b-1,a+20+(d+1)*b-1];t?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function T(){if(!a||m)return;if(k(!0),a.y++,r(a)&&(a.y--,k(!1),V(a),P(),G(),r(a))){m=!0,clearInterval(f),setTimeout(R,50);return}k(!1),A(d);const c=BTN_PLAY.read();const b=c?100:J;f._interval!==b&&(clearInterval(f),f=setInterval(T,b))}function a2(){const a=d.x2+65;const b=d.y1+25;const c=20;g.setFont('6x8',2);const f=n.toString();const h=g.stringWidth(f);const i=16;g.setColor('#000'),g.fillRect(a-h/2-2,b+c-6,a+h/2+2,b+c+i-4),g.setColor('#FFF'),g.drawString('SCORE',a,b),e.apply(),g.drawString(f,a,b+c)}function a3(){C();const a=u/2;const b=x/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString(I,a+10,b-50),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to START',a+10,b-15),S('USER/Piptris/gear.json',a-24,b-29),U()}function U(){const d=u/2;const a=10;const f=p.y2-15;const h=q.length*a;const i=q[0].length*a;const b=f-h-10;const c=d-i/2;g.setFont('6x8',1),g.setColor('#FFF'),g.drawString('<- BLOCK TYPE ->',d,f),g.setColor('#000'),g.fillRect(c-2,b-2,c+i+2,b+h+2),e.apply();for(let e=0;e<q.length;e++)for(let j=0;j<q[e].length;j++)if(q[e][j]){const d=c+j*a;const f=b+e*a;const h=d+a-1;const i=f+a-1;t?g.drawRect(d,f,h,i):g.fillRect(d,f,h,i)}}function a4(){if(!a||m)return;k(!0);while(!r(a))a.y++;a.y--,k(!1),V(a),P(),D(),G(),k(!1)}function v(a,c){g.setColor('#000'),g.fillRect(i+a*b,j+c*b,i+(a+1)*b-1,j+(c+1)*b-1)}function F(){let b=Math.floor(Math.random()*O.length);let a=O[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function a5(){W()}function a6(b){let a=Date.now();if(a-L<_)return;L=a,b===0?a4():ac(b)}function a7(a){aa(a>0?1:-1)}function a8(){X(),clearInterval(f),bC.clear(1).flip(),E.reboot()}function a9(){try{s=fs.readdir(N).filter(a=>a.endsWith('.wav')).sort()}catch(a){print('Failed to load Piptris music files:',a),s=[]}}function V(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(h[(a.y+b)*c+a.x+d]=1)}function aa(c){if(m||!a)return;let b=a.x;if(a.x+=c,r(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&v(b+e,a.y+d);k(!1),A(d)}function W(){if(!s.length)return;const a=s[Math.floor(Math.random()*s.length)];Pip.audioStop(),Pip.audioStart(N+'/'+a),rd.setVol(.5)}function ab(){h.fill(0),g.setColor('#000'),g.fillRect(i,j,i+c*b-1,j+o*b-1)}function ac(f){if(m||!a)return;const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,r(a)){a.shape=c;return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&v(a.x+g,a.y+d);k(!1),A(d)}function X(){Pip.removeAllListeners(y),Pip.removeAllListeners(z),Pip.removeAllListeners(K),Pip.removeAllListeners(M)}function ad(){Pip.on(y,a6),Pip.on(z,a7),Pip.on(K,a8),Pip.on(M,a5)}function G(){l||(l=F()),a=l,l=F(),D(),r(a)&&(m=!0,clearInterval(f),setTimeout(()=>{R()},50))}function Y(){clearInterval(f),X(),a9(),W(),n=0,B=0,m=!1,a=null,l=F(),C(),ab(),A(d),G(),D(),a0(),ad(),f=setInterval(T,J)}const H={};const I='Piptris';const Z='2.1.0';let a=null;let J=800;let l=null;let b=10;let w=null;let m=!1;let B=0;let f=null;let s=[];let n=0;let t=!1;const u=g.getWidth();const x=g.getHeight();const p={x1:60,x2:u-60,y1:10,y2:x-10};const c=10;const o=20;const h=new Uint8Array(c*o);const i=(p.x1+p.x2)/2-b*c/2;const j=p.y1+(p.y2-p.y1)/2-b*o/2;const d={x1:i-1,y1:j-1,x2:i+c*b,y2:j+o*b};const y='knob1';const z='knob2';const K='torch';const _=100;let L=0;const M='audioStopped';const N='USER/Piptris';const q=[[0,1,0],[1,1,1]];const O=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],q,[[1,1],[1,1]]];const e={self:[0,1,0],apply:function(){g.setColor(this.self[0],this.self[1],this.self[2])},get:function(){return this.self},set:function(a,b,c,d){if(a===undefined||b===undefined||c===undefined||d){const a=g.getColor().toString(16);for(let e=0;e<3;e++)this.self[e]=parseInt(a.charAt(e),16)/15}else this.self[0]=a,this.self[1]=b,this.self[2]=c;return this}};return H.run=function(){function a(){t=!t,U()}bC.clear(),a3(),Pip.on(y,a),Pip.on(z,a),w=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(w),Pip.removeListener(y,a),Pip.removeListener(z,a),Y())},100)},H}Piptris().run()