function Waveform(){const d={};let e=0;let c=null;let f=null;let a=null;let b=null;return d.drawBorder=function(){for(let a=0;a<40;a++){const c=a%5===0?3:1;const b=a%5===0?2:1;bC.setColor(c),bC.drawLine(245+a*3,143-b,245+a*3,143),bC.drawLine(367-b,22+a*3,367,22+a*3)}bC.setColor(3).drawLine(245,144,367,144).drawLine(368,144,368,22),bC.flip()},d.drawCurrentlyPlaying=function(){if(Pip.Radio.currentAudio!==f&&(bC.setColor(0).fillRect(244,154,400,180),f=Pip.Radio.currentAudio),Pip.Radio.currentAudio){const a=Pip.Radio.currentAudio.split('/').pop().replace(/\.wav$/i,'');const b=a.length>19?a.slice(0,16)+'...':a;bC.setFontMonofonto16().setColor(3).drawString(b,244,155).flip()}},d.start=function(){e=0,a=Graphics.createArrayBuffer(120,120,2,{msb:!0}),E.getAddressOf(a,0)===0&&(a=undefined,E.defrag(),a=Graphics.createArrayBuffer(120,120,2,{msb:!0})),b=new Uint16Array(60);for(let a=0;a<60;a+=2)b[a]=a*2;c&&clearInterval(c),c=setInterval(()=>{if(!a)return;if(a.clearRect(0,0,119,119),Pip.radioClipPlaying)Pip.getAudioWaveform(b,20,100);else if(Pip.radioOn&&(typeof RADIO_AUDIO)[0]!='u')for(let a=1;a<60;a+=2)b[a]=E.clip(60+(analogRead(RADIO_AUDIO)-.263)*600,0,119);else{let a=e;for(let c=1;c<60;c+=2)b[c]=60+Math.sin(a)*45*Math.sin((a+=.6)*.13)}a.drawPolyAA(b),e+=.3,Pip.blitImage(a,285,85,{noScanEffect:!0})},50)},d.stop=function(){c&&clearInterval(c),c=null,f=null,b=null,a&&(a=null,E.defrag())},d}function CustomMenu(){function h(a){b&&l(a)}function k(a){if(g){g=!1;return}a!==0||(f&&Pip.Radio.currentAudio===f&&(b=!1,Pip.audioStop(),Pip.Radio.currentAudio=null,Pip.radioClipPlaying=!1,bC.setColor(0).fillRect(244,154,400,180),bC.flip()),Pip.Radio.waveform&&Pip.Radio.waveform.drawCurrentlyPlaying())}function q(a){c&&(clearInterval(c),c=null),c=setInterval(()=>{const c=BTN_PLAY.read();!o&&c&&(rd.isOn()&&rd.enable(!1),Pip.radioKPSS=!1,Pip.radioClipPlaying=!1,Pip.audioStop(),f=null,Pip.Radio.currentAudio=null,Pip.radioClipPlaying=!1,j?(s(),b=!1,e=[],d=0,Pip.fadeOff([LED_TUNING],Math.pow(2,Pip.brightness/2)/1024),j=!1):(b=!0,e=a.slice().sort(()=>Math.random()-.5),d=0,l(a),Pip.fadeOn([LED_TUNING],Math.pow(2,Pip.brightness/2)/1024),j=!0)),o=c},100)}function t(a){Pip.radioClipPlaying=!1,b=!1,f='/RADIO/'+a,g=!0,Pip.Radio.currentAudio===f?(Pip.audioStop(),Pip.Radio.currentAudio=null,Pip.radioClipPlaying=!1,bC.setColor(0).fillRect(244,154,400,180),bC.flip()):(Pip.Radio.currentAudio=f,Pip.audioStart(Pip.Radio.currentAudio),Pip.radioClipPlaying=!0,Pip.Radio.waveform&&Pip.Radio.waveform.drawCurrentlyPlaying())}function r(){}function l(b){d>=e.length&&(e=b.slice().sort(()=>Math.random()-.5),d=0),Pip.Radio.currentAudio&&(Pip.audioStop(),Pip.Radio.currentAudio=null,Pip.radioClipPlaying=!1);const a=e[d++];Pip.Radio.currentAudio='/RADIO/'+a,Pip.audioStart(Pip.Radio.currentAudio),Pip.radioClipPlaying=!0,Pip.removeListener('audioStopped',h),Pip.on('audioStopped',h),Pip.Radio.waveform&&Pip.Radio.waveform.drawCurrentlyPlaying()}function m(f){Pip.radioClipPlaying=!1,bC.clear(1);const o=Math.floor((f.length-1)/ i);a<0&&(a=0),a>o&&(a=o);const s=a*i;const u=f.slice(s,s+i);const j=Object.assign({},{'':{x2:200}});a===0&&(j.RANDOM=()=>{b=!0,e=f.slice().sort(()=>Math.random()-.5),d=0,l(f)}),u.forEach(b=>{const a=b.replace(/\.wav$/i,'');const c=a.length>19?a.slice(0,16)+'...':a;j[c]=()=>t(b)}),a>0&&(j['< PREV']=()=>{g=!0,a--,Pip.Radio.waveform&&(Pip.Radio.waveform.stop(),Pip.Radio.waveform=null),m(f),Pip.Radio.waveform=Waveform(),Pip.Radio.waveform&&(Pip.Radio.waveform.start(),Pip.Radio.waveform.drawBorder())}),(a+1)*i<f.length&&(j['NEXT >']=()=>{g=!0,a++,Pip.Radio.waveform&&(Pip.Radio.waveform.stop(),Pip.Radio.waveform=null),m(f),Pip.Radio.waveform=Waveform(),Pip.Radio.waveform&&(Pip.Radio.waveform.start(),Pip.Radio.waveform.drawBorder())}),E.showMenu(j),Pip.Radio.waveform&&Pip.Radio.waveform.drawCurrentlyPlaying(),q(f),Pip.removeListener('knob1',k),Pip.on('knob1',k),Pip.knob1Click=r,Pip.removeListener('audioStopped',h),b&&Pip.on('audioStopped',h);const n=Pip.removeSubmenu;Pip.removeSubmenu=function a(){LED_TUNING.read()&&LED_TUNING.write(0),Pip.Radio.waveform&&(Pip.Radio.waveform.stop(),Pip.Radio.waveform=null),bC.clear(1),bC.flip(),Pip.audioStop(),Pip.Radio.currentAudio=null,Pip.radioClipPlaying=!1,b=!1,Pip.removeListener('audioStopped',h),Pip.removeListener('knob1',k),c&&(clearInterval(c),c=null),Pip.removeSubmenu===a&&delete Pip.removeSubmenu,(typeof n)[0]=='f'&&n!==a&&n(),Pip.knob1Click=p}}function s(){Pip.audioStop(),Pip.Radio.currentAudio=null,Pip.radioClipPlaying=!1,rd.isOn()&&rd.enable(!1),Pip.radioKPSS=!1,Pip.radioClipPlaying=!1,bC.setColor(0).fillRect(244,154,400,180),bC.flip()}const n={};Pip.Radio.waveform||(Pip.Radio.waveform=Waveform());let c=null;let o=!1;let j=!1;let a=null;let i=5;let b=!1;let p=null;let d=null;let e=null;let f=null;let g=!1;return n.run=function(){rd._options||rd.setupI2C(),s(),bC.clear(1),p=Pip.knob1Click,Pip.knob1Click=r;let b=[];try{b=fs.readdir('/RADIO').filter(a=>a.endsWith('.wav')).sort(),print('Files loaded from "/radio":',b.length)}catch(a){print('Failed to load radio files:',a),b=[]}a=0,e=[],d=0,m(b),Pip.Radio.waveform&&(Pip.Radio.waveform.stop(),Pip.Radio.waveform=null),Pip.Radio.waveform=Waveform(),Pip.Radio.waveform.start(),Pip.Radio.waveform.drawBorder(),q(b)},n}function DefaultRadioExtended(){function b(){Pip.Radio.currentAudio&&(Pip.audioStop(),Pip.Radio.currentAudio=null,Pip.radioClipPlaying=!1,Pip.radioKPSS=!1)}const a={};return Pip.Radio.waveform||(Pip.Radio.waveform=Waveform()),a.run=function(){b(),Pip.Radio.waveform&&(Pip.Radio.waveform.stop(),Pip.Radio.waveform=null),bC.clear(1),submenuRadio()},a}function CustomRadioBootloader(){const a={};const b='Custom Radio Bootloader';const c='2.5.0';return a.run=function(){let a;try{const b='USER/CustomRadio/options.json';const c=fs.readFileSync(b);a=JSON.parse(c)}catch(b){a=null}if(a&&a.enabled&&(typeof MODEINFO)[0]!='u'&&(typeof MODE)[0]!='u'&&MODEINFO[MODE.RADIO]){const a=MODEINFO[MODE.RADIO];a.fn&&delete a.fn,a.submenu={LOCAL:DefaultRadioExtended().run,CUSTOM:CustomMenu().run}}},a}Pip.Radio={currentAudio:null,waveform:null},Pip.remove||(Pip.remove=function(){Pip.Radio.waveform&&(Pip.Radio.waveform.stop(),Pip.Radio.waveform=null),Pip.removeAllListeners(),(typeof E.gc)[0]=='f'&&E.gc()}),CustomRadioBootloader().run()